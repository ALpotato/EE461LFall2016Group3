<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Welcome to R2Beat!</title>
    <style>
        html, body, ul, li, p, a, input, div {
            font-family: "Courier New", serif;
            margin: 0;
            padding: 0;
        }

        body {
            background: rgb(39, 40, 34);
        }

        li {
            list-style: none;
        }

        .keyContainer {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 62px;
            z-index: 1000000000;
            background: #000;
            background: url(receptors.png);
            background-size: 100% 100%;
        }

        .keyContainer p {
            margin: 5px 5px 2px;
            width: 63px;
            height: 50px;
            font-size: 30px;
            line-height: 50px;
            text-align: center;
            float: left;
            cursor: pointer;
            z-index: 1000000000;
        }

        .container {
            overflow: hidden;
            position: absolute;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            margin: auto;
            width: 300px;
            height: 532px;
            background: #000;
            background-size: 100% 100%;
            border: 2px solid #fff;
            z-index: 0;
        }

        .container ul {
            width: 75px;
            height: 100%;
            float: left;
            position: relative;
            overflow: hidden;
        }

        .container ul li {
            position: absolute;
            margin: 5px;
            width: 65px;
            height: 50px;
            background-size: contain;
            background: #000 center, center;
            text-align: center;
            line-height: 60px;
            color: #fff;
            border-radius: 4px;
            z-index: 1000000000000;
        }

        #start {
            width: 100%;
            height: 100%;
            line-height: 100px;
            text-align: center;
            cursor: pointer;
            position: absolute;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            border: 0;
            margin: auto;
            color: #fff;
            text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px #fff, 0 0 40px #ff00de, 0 0 70px #ff00de;
            background-size: 100% 100%;
            z-index: 1000000000000;
        }

        #head_name {
            font-size: 56px;
            width: 100%;
            height: 100px;
            position: absolute;
            left: 0;
            top: 0;
            right: 0;
            bottom: 150px;
            margin: auto;
            z-index: 10000001;
            text-shadow: none;
            background: rgba(0, 0, 0, 0.8);
        }

        #start_inner {
            font-size: 36px;
            width: 100%;
            height: 100px;
            position: absolute;
            left: 0;
            top: 50px;
            right: 0;
            bottom: 0;
            margin: auto;
            z-index: 10000001;
        }

        #loading {
            font-size: 36px;
            width: 100%;
            height: 100px;
            position: absolute;
            left: 0;
            top: 50px;
            right: 0;
            bottom: 0;
            margin: auto;
            z-index: 10000001;
            display: none;
        }

        #score {
            font-size: 16px;
            position: absolute;
            right: 0;
            top: 0;
            border: 0;
            padding: 10px 15px;
            color: #fff;
            background: rgba(166, 226, 46, 0.5);
        }

        #score:before {
            content: "Score:";
        }

        #life {
            font-size: 16px;
            padding: 10px 15px;
            left: 0;
            top: 0;
            border: 0;
            color: #fff;
            background: rgba(249, 38, 76, 0.5);
            position: absolute;
        }

        #life:before {
            content: "Life:";
        }

        #status {
            width: 100%;
            text-align: center;
            position: absolute;
            right: 0;
            top: 150px;
            border: 0;
            color: #fff;
            font-size: 40px;
            text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px #fff, 0 0 40px #ff00de, 0 0 70px #ff00de;
            -webkit-animation: track 0.1s linear 1;
            -webkit-transition: track 0.1s linear;
        }

        @-webkit-keyframes track {
            0% {
                transform: scale(1, 1);
            }
            100% {
                transform: scale(1.3, 1.3);
            }
        }

        .ruler01 {
            width: 100%;
            height: 5px;
            background: rgba(255, 255, 255, 0.7);
            position: absolute;
            top: 460px;
        }

        .ruler02 {
            width: 100%;
            height: 10px;
            background: rgba(0, 0, 0, 0.7);
            position: absolute;
            top: 465px;
        }

        #gameRestart {
            font-size: 16px;
            position: absolute;
            right: 0;
            top: 50px;
            border: 0;
            padding: 10px 15px;
            color: #fff;
            z-index: 10000;
            cursor: pointer;
            display: none;
        }
    </style>
</head>

<body>
<audio id="music" preload="auto">
    <source src="Extratone%20Pirates.mp3" type="audio/ogg">
</audio>
<div class="container" id="container">
    <div id="start">
        <div id="head_name">R2Beat!</div>
        <div id="start_inner">Start</div>
    </div>
    <div id="loading">loading...</div>
    <div id="status"></div>
    <div id="score">0</div>
    <div id="life">100</div>

    <div id="gameRestart">Restart</div>

    <div class="ruler01"></div>
    <div class="ruler02"></div>

    <div class="keyContainer">
        <p id="p01"></p>
        <p id="p02"></p>
        <p id="p03"></p>
        <p id="p04"></p>
    </div>
</div>
</body>
<script>
    window.onload = function () {
        var container = document.getElementById('container');
        var start = document.getElementById('start');
        var loading = document.getElementById('loading');
        var start_inner = document.getElementById('start_inner');
        var gameRestart = document.getElementById('gameRestart');

        var ul = container.getElementsByTagName('ul');
        var p = container.getElementsByTagName('p');
        var li = container.getElementsByTagName('li');
        var scoreTag = document.getElementById('score');
        var status = document.getElementById('status');
        var life = document.getElementById('life');

        var music = document.getElementById('music');
        var scoreChange = 0;
        var combo = 0;
        var maxCombo = 0;
        var miss = 0;
        var bad = 0;
        var good = 0;
        var great = 0;
        var perfect = 0;
        var maxScore = 100; //TODO: is it really 100?
        var speed = 7;
        var timer = null;
        var ended = 0;
        var noteFile = [{"column": 1, "time": 190}, {"column": 1, "time": 430}, {
            "column": 1,
            "time": 670
        }, {"column": 1, "time": 910}, {"column": 2, "time": 1030}, {"column": 1, "time": 1150}, {
            "column": 1,
            "time": 1390
        }, {"column": 1, "time": 1630}, {"column": 1, "time": 1870}, {"column": 3, "time": 1990}, {
            "column": 1,
            "time": 2110
        }, {"column": 1, "time": 2350}, {"column": 1, "time": 2590}, {"column": 1, "time": 2830}, {
            "column": 2,
            "time": 2950
        }, {"column": 1, "time": 3070}, {"column": 1, "time": 3310}, {"column": 1, "time": 3550}, {
            "column": 2,
            "time": 3790
        }, {"column": 4, "time": 4030}, {"column": 4, "time": 4270}, {"column": 4, "time": 4510}, {
            "column": 4,
            "time": 4750
        }, {"column": 3, "time": 4870}, {"column": 4, "time": 4990}, {"column": 4, "time": 5230}, {
            "column": 4,
            "time": 5470
        }, {"column": 4, "time": 5710}, {"column": 2, "time": 5830}, {"column": 4, "time": 5950}, {
            "column": 4,
            "time": 6190
        }, {"column": 4, "time": 6430}, {"column": 4, "time": 6670}, {"column": 3, "time": 6790}, {
            "column": 2,
            "time": 6910
        }];

        // create the four uls that acts as columns for the four arrows moving up
        for (var i = 0; i < 4; i++) {
            var ulChange = document.createElement('ul');
            container.appendChild(ulChange);
        }
        start_inner.onclick = play;

        // move arrows up
        function move(obj) {
            clearTimeout(obj.timer);
            clearInterval(obj.timer);
            obj.timer = setInterval(function () {
                if(obj.style.top < 62) {
                    clearInterval(obj.timer);
                }
                obj.style.top = obj.offsetTop + speed + 'px';
            }, 30);
        }

        function generate(column, time) {
            var liChange = document.createElement('li');
            liChange.style.background = arrow(column);
            ul[column].appendChild(liChange);
            liChange.timer = setTimeout(move(liChange), time);
        }

        function arrow(column) {
            switch (column) {
                case 0:
                    return 'url(leftarrow.png)';
                case 1:
                    return 'url(downarrow.png)';
                case 2:
                    return 'url(uparrow.png)';
                case 3:
                    return 'url(rightarrow.png)';
            }
        }

        // start game
        function play() {
            start.style.display = "none";
            loading.style.display = "initial";
            gameRestart.style.display = "initial";
            status.innerHTML = "";
            for (var n in noteFile) {
                var column = parseInt(noteFile[n].column) - 1;
                var time = parseInt(noteFile[n].time);
                generate(column, time);
            }
            music.play();
        }

        music.addEventListener("ended", function () {
            music.currentTime = 0;
            ended = 1;
            console.log("ended");
        });

        // end game
        function EndGame() {
            console.log(status.innerHTML.toString());
            clearInterval(timer);
            for (var i = 0; i < li.length; i++) {
                clearTimeout(li[i].timeout);
            }
            for (i = 0; i < ul.length; i++) {
                ul[i].innerHTML = '';
            }
            scoreChange = 0;
            speed = 7;
        }

        // check remaining life
        function lifeCheck() {
            if (life.innerHTML == 0) {
                life.innerHTML = "Dead";
                status.innerHTML = " Score: F" + '<br />' + "Press F to restart";
                EndGame();
            }
        }

        // Core judgement functions
        function processKeyPress(n) {
            if (ended == 1/*!ul[n].children.length*/) {
                if (scoreChange == maxScore) {
                    status.innerHTML = " Score: AAA" + '<br />' + "Combo: " + maxCombo + '<br />' + "Press F to restart";
                }
                else if (scoreChange >= maxScore * 0.99) {
                    status.innerHTML = " Score:  AA" + '<br />' + "Combo: " + maxCombo + '<br />' + "Press F to restart";
                }
                else if (scoreChange >= maxScore * 0.97) {
                    status.innerHTML = " Score:  A+" + '<br />' + "Combo: " + maxCombo + '<br />' + "Press F to restart";
                }
                else if (scoreChange >= maxScore * 0.92) {
                    status.innerHTML = " Score:  A" + '<br />' + "Combo: " + maxCombo + '<br />' + "Press F to restart";
                }
                else if (scoreChange >= maxScore * 0.90) {
                    status.innerHTML = " Score:  A-" + '<br />' + "Combo: " + maxCombo + '<br />' + "Press F to restart";
                }
                else if (scoreChange >= maxScore * 0.88) {
                    status.innerHTML = " Score:  B+" + '<br />' + "Combo: " + maxCombo + '<br />' + "Press F to restart";
                }
                else if (scoreChange >= maxScore * 0.82) {
                    status.innerHTML = " Score:  B" + '<br />' + "Combo: " + maxCombo + '<br />' + "Press F to restart";
                }
                else if (scoreChange >= maxScore * 0.80) {
                    status.innerHTML = " Score:  B-" + '<br />' + "Combo: " + maxCombo + '<br />' + "Press F to restart";
                }
                else if (scoreChange >= maxScore * 0.78) {
                    status.innerHTML = " Score:  C+" + '<br />' + "Combo: " + maxCombo + '<br />' + "Press F to restart";
                }
                else if (scoreChange >= maxScore * 0.72) {
                    status.innerHTML = " Score:  C" + '<br />' + "Combo: " + maxCombo + '<br />' + "Press F to restart";
                }
                else if (scoreChange >= maxScore * 0.70) {
                    status.innerHTML = " Score:  C-" + '<br />' + "Combo: " + maxCombo + '<br />' + "Press F to restart";
                }
                else if (scoreChange >= maxScore * 0.68) {
                    status.innerHTML = " Score:  D+" + '<br />' + "Combo: " + maxCombo + '<br />' + "Press F to restart";
                }
                else if (scoreChange >= maxScore * 0.62) {
                    status.innerHTML = " Score:  D" + '<br />' + "Combo: " + maxCombo + '<br />' + "Press F to restart";
                }
                else if (scoreChange >= maxScore * 0.60) {
                    status.innerHTML = " Score:  D-" + '<br />' + "Combo: " + maxCombo + '<br />' + "Press F to restart";
                }
                else {
                    status.innerHTML = "done";
                }
                EndGame();
                return;
            }
            var height = coll(ul[n].children[0], p[n]);

            console.log(typeof(height));
            console.log(height);

            if (height) {
                ul[n].removeChild(ul[n].children[0]);
                scoreTag.innerHTML = scoreChange;
            } else {
                status.innerHTML = "MISS";
                lifeCheck();
                ul[n].removeChild(ul[n].children[0]);
            }
        }

        function reload() {
            document.location.reload();
            gameRestart.style.display = "none";
        }

        // mouse onclick events
        gameRestart.onclick = reload;

        // key down event
        document.onkeydown = function (ev) {
            console.log("clicked");
            var event = ev || event;

            // processKeyPress key press
            switch (event.keyCode) {
                    // change these number for different keys, default qwop
                case 81: //Q
                    processKeyPress(0);
                    break;
                case 87: //W
                    processKeyPress(1);
                    break;
                case 79: //O
                    processKeyPress(2);
                    break;
                case 80: //P
                    processKeyPress(3);
                    break;
                case 70: //F for reload
                    reload();
                    break;
            }
        };

        // obtain note location
        function getPos(obj) {
            var left = 0;
            var top = 0;
            while (obj) {
                left += obj.offsetLeft;
                top += obj.offsetTop;
                obj = obj.offsetParent
            }
            return {'left': left, 'top': top};
        }

        // TODO: this totally failed
        function coll(arrow, receptor) {
            //var tapTime = Date.now() - noteFile.trueTime;
            var arrowL = getPos(arrow).left;
            var arrowR = getPos(arrow).left + arrow.offsetWidth;
            var arrowT = getPos(arrow).top;
            var arrowB = getPos(arrow).top + arrow.offsetHeight;
            // console.log("distance from the top:" + t1);
            var receptorL = getPos(receptor).left;
            var receptorR = getPos(receptor).left + receptor.offsetWidth;
            var receptorT = getPos(receptor).top;
            var receptorB = getPos(receptor).top + receptor.offsetHeight;
            if (arrowL > receptorR || arrowR < receptorL) {
                // status.innerHTML="WRONG!";
                return false;
            }
            if (arrowB >= 485 && arrowB <= 528) {
                status.innerHTML = "Perfect!";
                scoreChange += 2;
                perfect += 1;
                combo += 1;
                life += 2;
                return true;
            }
            else if (arrowB > 460 && arrowB < 560) {
                status.innerHTML = "Great!";
                scoreChange += 1;
                great += 1;
                combo += 1;
                life += 1;
                return true;
            }
            else if (arrowB > 440 && arrowB < 580) {
                status.innerHTML = "Good";
                good += 1;
                combo += 1;
            }
            else if (arrowB > 410 && arrowB < 600) {
                status.innerHTML = "Bad";
                bad += 1;
                combo = 0;
                scoreChange -= 1;
                life -= 5;
            }
            else {
                status.innerHTML = "Miss";
                miss += 1;
                combo = 0;
                scoreChange -= 2;
                life -= 10;
            }
            if (combo > maxCombo) {
                maxCombo = combo;
            }
        }
    };
</script>
</html>
